<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°¾ç›˜äº¤æ˜“æ—¥å¿—</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@7/babel.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f8f9fa; }
    .container { max-width: 600px; margin: 0 auto; padding: 16px; }
    .header { background: #1E90FF; color: white; padding: 16px; border-radius: 10px; text-align: center; margin: 16px; }
    .card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .input { width: 100%; border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 8px; box-sizing: border-box; }
    button { padding: 10px 16px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; }
    .btn-primary { background: #1E90FF; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    .profit { color: #28a745; font-weight: bold; }
    .loss { color: #dc3545; font-weight: bold; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; margin: 16px; text-align: center; color: #856404; }
    textarea.input { resize: vertical; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const STORAGE_KEY = 'weiban_trades_v2';
    const SETTINGS_KEY = 'weiban_settings_v2';

    function App() {
      const [trades, setTrades] = useState([]);
      const [settings, setSettings] = useState({ totalCapital: 20000, maxDrawdown: 6, stopEndDate: null });
      const [form, setForm] = useState({
        date: new Date().toISOString().split('T')[0],
        code: '', name: '', sector: '', buyTime: '14:45',
        buyPrice: '', sellTime: '', sellPrice: '',
        quantity: '100', reason: '', nextOpen: '', notes: ''
      });
      const [editId, setEditId] = useState(null);
      const [modal, setModal] = useState(false);

      // åŠ è½½æ•°æ®
      useEffect(() => {
        const load = () => {
          const ts = localStorage.getItem(STORAGE_KEY);
          const ss = localStorage.getItem(SETTINGS_KEY);
          setTrades(ts ? JSON.parse(ts) : []);
          if (ss) setSettings(JSON.parse(ss));
        };
        load();
      }, []);

      const saveTrades = (data) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      };
      const saveSettings = (data) => {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
      };

      // ä»…è®¡ç®—å·²å¹³ä»“äº¤æ˜“çš„æ€»ç›ˆäº
      const realizedTrades = trades.filter(t => t.sellPrice && t.sellPrice.trim() !== '');
      const totalProfit = realizedTrades.reduce((sum, t) => sum + parseFloat(t.profit || 0), 0);
      const drawdownPercent = ((totalProfit / settings.totalCapital) * 100).toFixed(2);

      // åˆ¤æ–­æ˜¯å¦å¤„äºåœç›˜æœŸï¼ˆåŒ…å«æ•´æ—¥ï¼‰
      const isStopped = () => {
        if (!settings.stopEndDate) return false;
        const stopDate = new Date(settings.stopEndDate);
        const today = new Date();
        // æ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼ˆå¿½ç•¥æ—¶åˆ†ç§’ï¼‰
        const stopYMD = stopDate.getFullYear() + '-' + String(stopDate.getMonth() + 1).padStart(2, '0') + '-' + String(stopDate.getDate()).padStart(2, '0');
        const todayYMD = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        return stopYMD >= todayYMD;
      };

      const handleSubmit = () => {
        if (isStopped()) {
          const stopDate = new Date(settings.stopEndDate);
          alert(`å› äºæŸè¶…${settings.maxDrawdown}%ï¼Œäº¤æ˜“æš‚åœè‡³ ${stopDate.toLocaleDateString()}`);
          return;
        }

        const { code, name, buyPrice, quantity } = form;
        if (!code || !name || !buyPrice || !quantity) {
          alert('è¯·å¡«å†™å¿…è¦å­—æ®µï¼šä»£ç ã€åç§°ã€ä¹°å…¥ä»·ã€æ•°é‡');
          return;
        }

        const buyPriceNum = parseFloat(buyPrice);
        const quantityNum = parseInt(quantity, 10);
        if (isNaN(buyPriceNum) || buyPriceNum <= 0) {
          alert('ä¹°å…¥ä»·å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—');
          return;
        }
        if (isNaN(quantityNum) || quantityNum < 100 || quantityNum % 100 !== 0) {
          alert('æ•°é‡å¿…é¡»æ˜¯100çš„æ•´æ•°å€ï¼ˆå¦‚100, 200...ï¼‰');
          return;
        }

        let profit = '';
        let profitRatio = '';

        if (form.sellPrice && form.sellPrice.trim() !== '') {
          const sellPriceNum = parseFloat(form.sellPrice);
          if (isNaN(sellPriceNum) || sellPriceNum < 0) {
            alert('å–å‡ºä»·å¿…é¡»æ˜¯éè´Ÿæ•°å­—');
            return;
          }
          profit = ((sellPriceNum - buyPriceNum) * quantityNum).toFixed(2);
          profitRatio = buyPriceNum > 0 ? (((sellPriceNum / buyPriceNum) - 1) * 100).toFixed(2) : '0.00';
        }

        const newTrade = {
          id: editId || Date.now().toString(),
          ...form,
          profit,
          profitRatio,
        };

        const newTrades = editId
          ? trades.map(t => t.id === editId ? newTrade : t)
          : [newTrade, ...trades];

        setTrades(newTrades);
        saveTrades(newTrades);

        // é£æ§æ£€æŸ¥ï¼šä»…åŸºäºå·²å®ç°ç›ˆäº
        const newRealizedTrades = newTrades.filter(t => t.sellPrice && t.sellPrice.trim() !== '');
        const newTotalProfit = newRealizedTrades.reduce((sum, t) => sum + parseFloat(t.profit || 0), 0);
        const newDrawdown = (newTotalProfit / settings.totalCapital) * 100;

        if (newDrawdown < -settings.maxDrawdown) {
          const twoWeeksLater = new Date();
          twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
          // è®¾ç½®ä¸ºå½“å¤©ç»“æŸï¼Œç¡®ä¿æ•´æ—¥åœç›˜
          twoWeeksLater.setHours(23, 59, 59, 999);

          const newSettings = { ...settings, stopEndDate: twoWeeksLater.toISOString() };
          setSettings(newSettings);
          saveSettings(newSettings);

          alert(`âš ï¸ é£æ§è§¦å‘ï¼ç´¯è®¡äºæŸè¶…${settings.maxDrawdown}%ï¼Œäº¤æ˜“æš‚åœè‡³ ${twoWeeksLater.toLocaleDateString()}`);
        }

        resetForm();
        setModal(false);
      };

      const resetForm = () => {
        setForm({
          date: new Date().toISOString().split('T')[0],
          code: '', name: '', sector: '', buyTime: '14:45',
          buyPrice: '', sellTime: '', sellPrice: '',
          quantity: '100', reason: '', nextOpen: '', notes: ''
        });
        setEditId(null);
      };

      const startEdit = (item) => {
        setForm({ ...item });
        setEditId(item.id);
        setModal(true);
      };

      const deleteTrade = (id) => {
        if (confirm('ç¡®è®¤åˆ é™¤è¯¥äº¤æ˜“è®°å½•ï¼Ÿ')) {
          const filtered = trades.filter(t => t.id !== id);
          setTrades(filtered);
          saveTrades(filtered);
        }
      };

      const openSettings = () => {
        const input = prompt('è¯·è¾“å…¥æ€»æœ¬é‡‘ï¼ˆå½“å‰ï¼šÂ¥' + settings.totalCapital.toLocaleString() + 'ï¼‰', settings.totalCapital);
        if (input !== null) {
          const capital = parseFloat(input);
          if (isNaN(capital) || capital <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°é‡‘é¢');
            return;
          }
          const newSettings = { ...settings, totalCapital: capital };
          setSettings(newSettings);
          saveSettings(newSettings);
          alert('æœ¬é‡‘å·²æ›´æ–°ä¸º Â¥' + capital.toLocaleString());
        }
      };

      return (
        <div className="container">
          <div className="header">
            <h1>ğŸ“ˆ å°¾ç›˜äº¤æ˜“æ—¥å¿—</h1>
            <p>æœ¬é‡‘: Â¥{settings.totalCapital.toLocaleString()}</p >
            <p>ç´¯è®¡ç›ˆäº: <span className={totalProfit >= 0 ? 'profit' : 'loss'}>
              Â¥{totalProfit.toFixed(2)} ({drawdownPercent}%)
            </span></p >
            {isStopped() && (
              <div className="warning">
                âš ï¸ äºæŸè¶…{settings.maxDrawdown}%ï¼Œæš‚åœäº¤æ˜“è‡³<br/>
                <strong>{new Date(settings.stopEndDate).toLocaleDateString()}</strong>
              </div>
            )}
          </div>

          <div style={{ display: 'flex', padding: '0 16px', marginBottom: '12px', gap: '8px' }}>
            <button className="btn-warning" onClick={openSettings}>âš™ï¸ æœ¬é‡‘</button>
            <button 
              className="btn-primary" 
              onClick={() => { 
                if (!isStopped()) { 
                  resetForm(); 
                  setModal(true); 
                } else { 
                  alert(`äº¤æ˜“å·²æš‚åœè‡³ ${new Date(settings.stopEndDate).toLocaleDateString()}`); 
                } 
              }}
            >
              + æ·»åŠ 
            </button>
          </div>

          {trades.length === 0 ? (
            <div className="card" style={{ textAlign: 'center', color: '#666' }}>
              æš‚æ— äº¤æ˜“è®°å½•
            </div>
          ) : (
            trades.map(t => (
              <div className="card" key={t.id}>
                <strong>{t.code}</strong> {t.name} | {t.date}
                <p>ä¹°å…¥: {t.buyPrice} â†’ å–å‡º: {t.sellPrice || 'æœªå–å‡º'}</p >
                <p>ç›ˆäº: 
                  {t.profit === '' ? 'æœªå®ç°' : (
                    <span className={parseFloat(t.profit) >= 0 ? 'profit' : 'loss'}>
                      Â¥{t.profit} ({t.profitRatio}%)
                    </span>
                  )}
                </p >
                <p>ç†ç”±: {t.reason || 'â€”'}</p >
                <div style={{ textAlign: 'right', marginTop: '8px' }}>
                  <button onClick={() => startEdit(t)}>âœï¸ ç¼–è¾‘</button>
                  <button className="btn-danger" onClick={() => deleteTrade(t.id)}>ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
              </div>
            ))
          )}

          {modal && (
            <div style={styles.modal}>
              <div style={styles.modalContent}>
                <h2>{editId ? 'ç¼–è¾‘' : 'æ·»åŠ '}äº¤æ˜“</h2>
                <input 
                  type="date" 
                  className="input" 
                  value={form.date} 
                  onChange={e => setForm({...form, date: e.target.value})} 
                />
                <input 
                  placeholder="è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š600000ï¼‰" 
                  className="input" 
                  value={form.code} 
                  onChange={e => setForm({...form, code: e.target.value})} 
                />
                <input 
                  placeholder="è‚¡ç¥¨åç§°" 
                  className="input" 
                  value={form.name} 
                  onChange={e => setForm({...form, name: e.target.value})} 
                />
                <input 
                  placeholder="ä¹°å…¥ä»·æ ¼" 
                  className="input" 
                  value={form.buyPrice} 
                  onChange={e => setForm({...form, buyPrice: e.target.value})} 
                  type="number" 
                  step="0.01"
                />
                <input 
                  placeholder="æ•°é‡ï¼ˆ100çš„å€æ•°ï¼‰" 
                  className="input" 
                  value={form.quantity} 
                  onChange={e => setForm({...form, quantity: e.target.value})} 
                  type="number" 
                />
                <input 
                  placeholder="å–å‡ºä»·æ ¼ï¼ˆå¯é€‰ï¼‰" 
                  className="input" 
                  value={form.sellPrice} 
                  onChange={e => setForm({...form, sellPrice: e.target.value})} 
                  type="number" 
                  step="0.01"
                />
                <textarea 
                  placeholder="äº¤æ˜“ç†ç”±" 
                  className="input" 
                  value={form.reason} 
                  onChange={e => setForm({...form, reason: e.target.value})} 
                  rows="3"
                ></textarea>
                <div style={{ marginTop: '20px', display: 'flex', justifyContent: 'space-between' }}>
                  <button onClick={() => setModal(false)}>å–æ¶ˆ</button>
                  <button className="btn-primary" onClick={handleSubmit}>{editId ? 'æ›´æ–°' : 'æ·»åŠ '}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const styles = {
      modal: { 
        position: 'fixed', 
        top: 0, 
        left: 0, 
        right: 0, 
        bottom: 0, 
        backgroundColor: 'rgba(0,0,0,0.5)', 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center',
        zIndex: 1000
      },
      modalContent: { 
        backgroundColor: 'white', 
        padding: '20px', 
        borderRadius: '10px', 
        width: '90%', 
        maxWidth: '500px'
      }
    };

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App />);
  </script>
</body>
</html>